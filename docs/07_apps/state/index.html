<!doctype html>
<html>
<head>
<title>State Management</title>
<link rel="stylesheet" href="/styles/prism.css">
<link rel="stylesheet" href="/styles/theme.css">

<script type="module">// module Kram_d693e88c_state (ES6)
          import { register } from "/scripts/oper.ative.js"
          
          console.log('Loading module "Kram_d693e88c_state"')
          export function Program ({connectStore, initializeStore}) {
            // JS Definition from scene 2
class Travelers extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: "open" }).appendChild(
      Travelers.html_template.cloneNode(true)
    );
    this._model = {};
    Travelers.init(this._model);
    this._observable = createObservable(this._model, this);
    this.onchange = this.handleChange.bind(this);
  }

  static init(model) {
    return Object.assign(model, { count: 2 });
  }

  connectedCallback() {
    const countInput = this.querySelector("input");

    if (countInput) {
      countInput.value = this.model.count.toString();
    }
  }

  get model() {
    return this._observable;
  }

  handleChange(event) {
    this.model.count = parseInt(event.target.value);
  }

  static html_template = template`<form>
    <slot></slot>
  </form>`;
}

customElements.define("travelers-form", Travelers);

// JS Definition from scene 3
class Schedule extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: "open" }).appendChild(
      Schedule.html_template.cloneNode(true)
    );
    this._model = {};
    Schedule.init(this._model);
    this._observable = createObservable(this._model, this);

    this.onchange = this.handleChange.bind(this);
  }

  static init(model) {
    const duration = 7;
    const firstDate = new Date();
    const lastDate = new Date(firstDate.getTime() + duration * this.msPerDay);

    Object.assign(model, {
      first: firstDate.toISOString().substring(0, 10),
      last: lastDate.toISOString().substring(0, 10),
    });
  }

  connectedCallback() {
    const firstInput = this.querySelector('input[name="first-date"]');
    const lastInput = this.querySelector('input[name="last-date"]');

    if (firstInput) {
      firstInput.value = this.model.first;
    }

    if (lastInput) {
      lastInput.value = this.model.last;
    }
  }

  get model() {
    return this._observable;
  }

  handleChange(event) {
    switch (event.target.name) {
      case "first-date":
        this.model.first = event.target.value;
        return;
      case "last-date":
        this.model.last = event.target.value;
        return;
    }
  }

  static firstDate({ first }) {
    return new Date(first);
  }

  static lastDate({ last }) {
    return new Date(last);
  }

  static days({ first, last }) {
    return this.daysBetween(first, last) + 1;
  }

  static nights({ first, last }) {
    return this.daysBetween(first, last);
  }

  static daysBetween(first, last) {
    const firstDate = new Date(first);
    const lastDate = new Date(last);

    return Math.ceil((lastDate - firstDate) / Schedule.msPerDay);
  }

  static msPerDay = 1000 * 60 * 60 * 24;

  static html_template = template`<form>
    <slot name="first"></slot>
    <slot name="last"></slot>
  </form>`;
}

customElements.define("schedule-form", Schedule);

// JS Definition from scene 4
class Invoice extends HTMLElement {
  constructor() {
    super();
    this.model = {};
    Invoice.init(this.model);
    this.attachShadow({ mode: "open" }).appendChild(
      Invoice.html_template.cloneNode(true)
    );
  }

  static init(model) {
    Object.assign(model, {
      rate: 200,
      currency: "€",
      rooms: 1,
      nights: 7,
    });
  }

  connectedCallback() {
    const rateSpan = this.shadowRoot.getElementById("room-rate");
    rateSpan.textContent = `${this.model.rate.toString()} ${
      this.model.currency
    }`;

    this.observe("travelers", "count", (count) => this.updateGuests(count));
    this.observe("schedule", "*", (schedule) =>
      this.updateNights(Schedule.nights(schedule))
    );
  }

  observe(attrName, prop, callback) {
    const selector = this.getAttribute(attrName);
    const observable = document.querySelector(selector);
    const currentValue =
      prop === "*" ? () => observable.model : () => observable.model[prop];
    const value = currentValue();

    if (callback) {
      callback(value);

      observable.addEventListener("observable:change", () =>
        callback(currentValue())
      );
    }

    return value;
  }

  updateGuests(guests) {
    const rooms = Math.ceil(guests / 2);
    const roomSpan = this.shadowRoot.getElementById("room-count");

    roomSpan.textContent = rooms.toString();
    this.model.rooms = rooms;
    this.updateTotal();
  }

  updateNights(nights) {
    const nightSpan = this.shadowRoot.getElementById("night-count");
    nightSpan.textContent = nights.toString();
    this.model.nights = nights;
    this.updateTotal();
  }

  updateTotal() {
    const totalSpan = this.shadowRoot.getElementById("total-charge");
    const total = this.model.rate * this.model.rooms * this.model.nights;
    totalSpan.textContent = `${total.toString()} ${this.model.currency}`;
  }

  static html_template = document.getElementById("invoice-template").content;
}

customElements.define("invoice-observer", Invoice);

// JS Definition from scene 5
function createObservable(root, eventTarget) {
  const OBSERVABLE_CHANGE_EVENT = "observable:change";

  console.log("creating Observable:", JSON.stringify(root));

  let proxy = new Proxy(root, {
    get: (target, prop, receiver) => {
      if (prop === "then") {
        return undefined;
      }
      const value = Reflect.get(target, prop, receiver);
      console.log(`Observable['${prop}'] => ${JSON.stringify(value)}`);
      return value;
    },
    set: (target, prop, newValue, receiver) => {
      const oldValue = root[prop];
      console.log(
        `Observable['${prop}'] <= ${JSON.stringify(
          newValue
        )}; was ${JSON.stringify(oldValue)}`
      );
      const didSet = Reflect.set(target, prop, newValue, receiver);
      if (didSet) {
        let evt = new CustomEvent(OBSERVABLE_CHANGE_EVENT, {
          bubbles: true,
          cancelable: true,
        });
        Object.assign(evt, { property: prop, oldValue, value: newValue });
        eventTarget.dispatchEvent(evt);
        console.log("dispatched event to target", evt, eventTarget);
      } else {
        console.log(`Observable['${prop}] was not set to ${newValue}`);
      }
      return didSet;
    },
  });

  return proxy;
}

// JS Definition from scene 6
function template(strings, ...values) {
  const html = strings.flatMap((s, i) => (i ? [values[i - 1], s] : [s]));
  let tpl = document.createElement("template");
  tpl.innerHTML = html;
  return tpl.content;
}

            return ({
              
            })
          }
          export function mount (mountpoint, initial) {
            let Store = {
              root: Object.assign({}, initial),
            };
            const connectStore = (path = ["root"]) => {
              let root = Store;
              path.forEach((key) => root = root[key]);
              return ({
                root,
                get: (key) => root[key],
                set: (key, value) => root[key] = value,
                keys: () => Object.keys(root),
              })};
            const program = Program({connectStore})
            return (n, container) => {
              program[n-1].call(container)
            }
          }
          register("Kram_d693e88c_state", {Program, mount})
        </script>
</head>
<body>
<template id="invoice-template">
  <dl>
    <div>
      <dt>Room Rate</dt>
      <dd id="room-rate">199 USD</dd>
    </div>
    <div>
      <dt>#Rooms</dt>
      <dd id="room-count">1</dd>
    </div>
    <div>
      <dt>#Nights</dt>
      <dd id="night-count">7</dd>
    </div>
    <div>
      <dt>Total</dt>
      <dd id="total-charge">1393 USD</dd>
    </div>
  </dl>
  <style>
    dl {
      display: flex;
      width: max-content;
      gap: 1rem;
    }
    dl > div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    dt {
      font-weight: bold;
    }
    dd {
      margin: 0;
    }
  </style>
</template>


<st-ative><script>
  const STORE_CHANGE_EVENT = "store:change";

  function createStore(eventTarget, initial = {}) {
    let root = Object.assign({}, initial);

    console.log("create Global Store for st-ative", JSON.stringify(root));

    return new Proxy(root, {
      get: (target, prop, receiver) => {
        const value = Reflect.get(target, prop, receiver);
        return value;
      },
      set: (target, prop, newValue, receiver) => {
        const oldValue = root[prop];
        const didSet = Reflect.set(target, prop, newValue, receiver);
        if (didSet) {
          eventTarget.dispatchEvent(changeEvent(prop, newValue, oldValue));
        }
        return didSet;
      },
    });
  }

  function changeEvent(prop, newValue, oldValue) {
    // ref: https://infrequently.org/2021/03/reactive-data-modern-js/
    let evt = new CustomEvent(STORE_CHANGE_EVENT, {
      bubbles: true,
      cancelable: true,
    });
    evt.oldValue = oldValue;
    evt.value = newValue;
    evt.property = prop;

    return evt;
  }

  customElements.define(
    "st-ative",
    class extends HTMLElement {
      constructor() {
        super();

        const storeRoot = [];
        let Store = createStore(this, {
          "current-scene": 1,
        });

        this.dataset.provider = JSON.stringify(storeRoot);

        this.observe = (key, watcher) => {
          if (watcher) {
            this.addEventListener(STORE_CHANGE_EVENT, (evt) => {
              if (evt.property === key) {
                watcher(evt.value, evt.oldValue);
              }
            });
          }
          return { value: Store[key] };
        };

        this.bind = (key, watcher) => {
          const observation = this.observe(key, watcher);
          return {
            get: () => Store[key],
            set: (newValue) => (Store[key] = newValue),
            ...observation,
          };
        };

        console.log("Store provider constructed");
      }
    }
  );
</script>

<!-- template -->
<article>
  
<navig-ative class="wguho-1wx"><!-- template --><footer>
  <h6><span>State Management
</span></h6>
  <span>
    <button name="previous">Previous</button>
    <input width="6" type="number" min="1" value="1">
    <button name="next">Next</button>
  </span>
</footer>

<style>.wguho-1wx{height:var(--heightFooter)}.wguho-1wx footer{display:flex;flex-direction:row;padding:0.5rem;gap:0.5rem;justify-content:space-between;align-items:baseline}.wguho-1wx footer>*{margin:0}@media print{.wguho-1wx footer{display:none}}</style>
<!-- /template -->

<script>
  console.log("Defining navig-ative...");

  customElements.define(
    "navig-ative",
    class extends HTMLElement {
      connectedCallback() {
        let provider = this.closest("[data-provider]");
        let numberInput = this.querySelector(':scope input[type="number"]');
        let previousButton = this.querySelector(
          ':scope button[name="previous"]'
        );
        let nextButton = this.querySelector(':scope button[name="next"]');

        console.log("Navig-ative attempting to connect...", provider);

        if (provider) {
          const { get, set } = provider.bind(
            "current-scene",
            (newValue) => (numberInput.value = newValue)
          );

          numberInput.value = get();

          numberInput.addEventListener("change", () => set(numberInput.value));

          previousButton.addEventListener("click", () => set(get() - 1));

          nextButton.addEventListener("click", () => {
            set(get() + 1);
          });

          console.log("Consolid-ative (webc)");
        }
      }
    }
  );
</script>
</navig-ative>
<consolid-ative class="wca28tbqe"><!-- <template> for consolid-ative --><main class="layout">
  
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  <main>
  <h3>Guest Info</h3>
  <travelers-form id="travelers">
    <label>
      Number of guests
      <input type="number">
    </label>
  </travelers-form>
  <hr>
  <h3>Travel Dates</h3>
  <schedule-form id="schedule">
    <label slot="first">
      Check-in on
      <input type="date" name="first-date">
    </label>
    <label slot="last">
      Check-out on
      <input type="date" name="last-date">
    </label>
  </schedule-form>
  <hr>
  <h3>Invoice</h3>
  <invoice-observer travelers="#travelers" schedule="#schedule">
  </invoice-observer>
</main>

</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code lang="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Guest Info<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>travelers<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>
      Number of guests
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Travel Dates<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schedule<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      Check-in on
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first-date<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      Check-out on
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last-date<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Invoice<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invoice-observer</span> <span class="token attr-name">travelers</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#travelers<span class="token punctuation">"</span></span> <span class="token attr-name">schedule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#schedule<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invoice-observer</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h1>State Management</h1>

<p>Dynamic web pages retrieves data (for example, from an API)
and inserts it into the HTML or DOM.
Originally, the code which rendered data as HTML ran on the server.
Doing so, however, meant that the entire page had to be
reloaded whenever any of the data changes.</p>

<p>To avoid that, developers started using Web APIs
which allow HTML or data to be loaded from the server,
after the page had been completely loaded and rendered.
The first of these APIs was called <code data-mark-around="`">XMLHTTPRequest</code>,
and this technique was often called AJAX, for Asynchronous Javascript and XML.
(At the time, XML was widely used for data APIs,
and XHTML, which cast HTML as strict XML, was promoted as a standard dialect.)</p>

<p>That data may have been formatted server-side as an HTML fragment,
which was simple to splice into the DOM.
But loading the data pre-formatted limited how the data could be used
and the extent to which the user could customize the presentation.
The next development was to serve raw data to the client,
which would use Javascript APIs to build the DOM dynamically.
Web applications written in this way came to be known as <em data-mark-around="_">Web 2.0</em> to
distinguish them from the earlier static or on-demand
server-generated HTML pages.</p>

<p>When a web application loads data from the server,
it is making a local copy of that data.
This copy becomes part of the application’s <em data-mark-around="_">state</em>.
Any processing performed client-side is based on that state.
Each time that part of the state is presented in a UI,
it is again copied and converted to digits or some other format.
As the state is passed to different parts of the UI,
many copies are created, resulting in <em data-mark-around="_">local state</em>.
Some of these copies may be <em data-mark-around="_">mutable</em>, meaning that they can be changed,
often in response to some user interaction.
Additionally, new values may be computed which depend on the state and
would be invalid if the state changes.</p>

<p>This is known as the Application State Management problem.
As state proliferates throughout an application,
it becomes unclear which copy of the data should be trusted.
Or, more colloquially, “Who owns the data?”.</p>

<p>Once we decide who owns the data,
we must ensure that all copies of the data are updated
whenever one of them is modified.
This is an example of the Cache Coherency problem,
often cited as one of the
most difficult problems in Computer Science,
right up there with “Naming Things”.</p>

<p>Multiple abstractions have been developed for solving this problem,
including Publisher-Subscriber, Immutable Data, and Observer patterns.
Though all are used in various web development frameworks,
we will focus on the Observer pattern, because it can be supported natively
in Javascript through the use of Proxy objects.</p>

<p>In this example, there are two forms which accept input from the user,
and an invoice, the specifics of which depend on the input values.
We’ve chosen to have each form manage the data that it collects,
while the invoice will observe those values, and update itself
whenever they change.</p>

</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  <travelers-form>
  <label> Number of guests <input type="number"> </label>
</travelers-form>

</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code lang="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span> Number of guests <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h2>Creating an Observable Model</h2>

<p>Let’s start by looking at the first form.
The traveler details has just one input, for the number of travelers.
So the model for this component contains just a single number,
which we’ll call <code data-mark-around="`">count</code>.</p>

<p>We keep the <code data-mark-around="`">&lt;input&gt;</code> value in sync with the model by initializing
the input’s value in <code data-mark-around="`">connectedCallback</code> and providing an event
handler for <code data-mark-around="`">onchange</code> events bubbling up from the input.
The event handler is very simple.
There is only one input to generate <code data-mark-around="`">onchange</code> events, so
we just need to set <code data-mark-around="`">count</code> to the target’s <code data-mark-around="`">value</code> property.</p>

<p>To make this component’s model observable from other components,
we add a <code data-mark-around="`">get model()</code> method.
Notice however that this method does not directly return <code data-mark-around="`">this._model</code>,
but rather <code data-mark-around="`">this._observable</code>, which we initialize by
calling <code data-mark-around="`">createObservable</code> in the constructor.
We will look at this function in detail later,
but for now we can think of <code data-mark-around="`">this._observable</code> as a wrapper
which allows us to update all observers of the model
whenever the <code data-mark-around="`">count</code> property is changed.</p>

<ide-ative data-language="js" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Travelers</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"open"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
      Travelers<span class="token punctuation">.</span>html_template<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_model <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Travelers<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observable <span class="token operator">=</span> <span class="token function">createObservable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onchange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> countInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>countInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      countInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observable<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> html_template <span class="token operator">=</span> template<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;form&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/form&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"travelers-form"</span><span class="token punctuation">,</span> Travelers<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  <schedule-form id="schedule">
  <label slot="first">
    Check-in on
    <input type="date" name="first-date">
  </label>
  <label slot="last">
    Check-out on
    <input type="date" name="last-date">
  </label>
</schedule-form>

</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code lang="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schedule<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    Check-in on
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first-date<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    Check-out on
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last-date<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h2>A Slightly More Complex Model</h2>

<p>The second form is more complicated because it has two inputs,
and the model maintains two values, which are dates.
The value of an <code data-mark-around="`">&lt;input type="date"&gt;</code> is a string in ISO 8601 format, i.e.,
of the form <code data-mark-around="`">YYYY-MM-DD</code>, and we’ll use that format for the model, too.
We also provide some utility functions to convert these strings to
Javascript <code data-mark-around="`">Date</code> objects, or to calculate the number of days
and nights in the range, so that observer components don’t need
to implement those operations themselves.</p>

<p>In the constructor, the model is initialized and an
observable is created, which is what we expose via the <code data-mark-around="`">get model()</code> method.
The <code data-mark-around="`">value</code> property of each input is initialized to the
corresponding model property in <code data-mark-around="`">connectedCallback</code>.
We also bind an event handler to capture <code data-mark-around="`">onchange</code> events bubbling up
from the two inputs.</p>

<p>Because this form contains more than one input,
<code data-mark-around="`">handleChange</code> must first determine which input was changed
before it can update the appropriate property of the model.
We reference the <code data-mark-around="`">name</code> attribute of the event target for this
purpose.</p>

<ide-ative data-language="js" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Schedule</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"open"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
      Schedule<span class="token punctuation">.</span>html_template<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_model <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Schedule<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observable <span class="token operator">=</span> <span class="token function">createObservable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>onchange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> firstDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>firstDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> duration <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msPerDay<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">first</span><span class="token operator">:</span> firstDate<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">last</span><span class="token operator">:</span> lastDate<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> firstInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[name="first-date"]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[name="last-date"]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      firstInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lastInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observable<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">"first-date"</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>first <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">"last-date"</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>last <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">firstDate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">lastDate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">days</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first<span class="token punctuation">,</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">daysBetween</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">nights</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first<span class="token punctuation">,</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">daysBetween</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">daysBetween</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> last</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> firstDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lastDate <span class="token operator">-</span> firstDate<span class="token punctuation">)</span> <span class="token operator">/</span> Schedule<span class="token punctuation">.</span>msPerDay<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> msPerDay <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> html_template <span class="token operator">=</span> template<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;form&gt;
    &lt;slot name="first"&gt;&lt;/slot&gt;
    &lt;slot name="last"&gt;&lt;/slot&gt;
  &lt;/form&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"schedule-form"</span><span class="token punctuation">,</span> Schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  <main>
  <travelers-form id="travelers"> </travelers-form>
  <schedule-form id="schedule"> </schedule-form>
  <invoice-observer travelers="#travelers" schedule="#schedule">
  </invoice-observer>
</main>

</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code lang="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>travelers<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schedule<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invoice-observer</span> <span class="token attr-name">travelers</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#travelers<span class="token punctuation">"</span></span> <span class="token attr-name">schedule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#schedule<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invoice-observer</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h2>Creating an Observer</h2>

<p>The invoice view has its own model,
which supplies the data required to render the invoice.
Some of the values in this model, such as the room rate,
are managed by the component itself.
But the other values depend on the data which is observable in the
form components we just created.
Whenever those values change, we want the invoice to be updated.
Therefore, our <code data-mark-around="`">Invoice</code> component needs to be an <em data-mark-around="_">observer</em> of
both <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code>.</p>

<p>The constructor for <code data-mark-around="`">Invoice</code> are similar to what we did for <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code>.
We create a <code data-mark-around="`">model</code> and initialize it.
This model does not need to be observable outside of the <code data-mark-around="`">Invoice</code> class,
so we don’t need to create <code data-mark-around="`">this._observable</code> and we don’t need the <code data-mark-around="`">get model()</code> method.
Nothing inside this component accepts user input, so there is no need for an <code data-mark-around="`">onchange</code>
handler.</p>

<p>Similarly, <code data-mark-around="`">connectedCallback</code> starts off by rendering the room rate data from the <code data-mark-around="`">model</code>
into the correct location in the <code data-mark-around="`">Invoice</code>’s shadow DOM.
We can use an <code data-mark-around="`">id</code> for this without worrying about conflicts with the light DOM.
Next, we need to render the other data from our model.</p>

<p>But the number of rooms depends on how many guests the user has entered;
the length of stay depends on the users’ travel schedule;
and the total depends on the number of rooms, length of stay, and the room rate.
We need to observe the <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code> component models,
and update the <code data-mark-around="`">Invoice</code> model before we can render the shadow DOM.
At the same time that we observe those values,
we will also arrange to update the model and DOM on any future changes.
That is what the <code data-mark-around="`">observe</code> method does,
in concert with the observable models created above.</p>

<p>Our application could potentially have multiple instances of <code data-mark-around="`">Travelers</code> or <code data-mark-around="`">Schedule</code>.
So the first step is to tell the <code data-mark-around="`">Invoice</code> component how to find the observable components.
Rather than hard-wire an <code data-mark-around="`">id</code> into the <code data-mark-around="`">class</code>,
we will pass CSS selector strings into <code data-mark-around="`">invoice-observer</code>
as attribute values and have <code data-mark-around="`">observe</code> use those selectors to locate the observable components.</p>

<p>At this point, we can get the current value of the property we want by indexing
into the component’s <code data-mark-around="`">model</code>.
But before we return from <code data-mark-around="`">observe</code>,
we want to make sure that this component gets updated every time
the observed value changes.</p>

<p>The <code data-mark-around="`">observe</code> method is generic.
We could factor it out into a base class to make it easier
to create observer components.
We can’t expect <code data-mark-around="`">observe</code> to be able to make the appropriate updates to the model and DOM
for whatever future changes may occur.
Instead, whenever we call <code data-mark-around="`">observe</code>,
and want it to react to future changes in the observed values,
we will also pass a callback function,
which will perform the update.</p>

<p>If a callback function is provided when calling <code data-mark-around="`">observe</code>,
it will be called whenever the value is observed,
being passed the latest observed value.
The first call occurs on the first observation,
before returning from <code data-mark-around="`">observe</code>.
In addition, we can set up an event handler for
<code data-mark-around="`">observable:change</code> events dispatched on the observable component.</p>

<ide-ative data-language="js" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Invoice</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Invoice<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"open"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
      Invoice<span class="token punctuation">.</span>html_template<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">rate</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">currency</span><span class="token operator">:</span> <span class="token string">"€"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">rooms</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nights</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rateSpan <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"room-rate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rateSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rate<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>currency
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token string">"travelers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGuests</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token string">"schedule"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">schedule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateNights</span><span class="token punctuation">(</span>Schedule<span class="token punctuation">.</span><span class="token function">nights</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">attrName<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> observable <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentValue <span class="token operator">=</span>
      prop <span class="token operator">===</span> <span class="token string">"*"</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observable<span class="token punctuation">.</span><span class="token function-variable function">model</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observable<span class="token punctuation">.</span>model<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">currentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      observable<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"observable:change"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">currentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateGuests</span><span class="token punctuation">(</span><span class="token parameter">guests</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rooms <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>guests <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> roomSpan <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"room-count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    roomSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> rooms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rooms <span class="token operator">=</span> rooms<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateNights</span><span class="token punctuation">(</span><span class="token parameter">nights</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nightSpan <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"night-count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nightSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> nights<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>nights <span class="token operator">=</span> nights<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> totalSpan <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"total-charge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rate <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rooms <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>nights<span class="token punctuation">;</span>
    totalSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>total<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>currency<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> html_template <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"invoice-template"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"invoice-observer"</span><span class="token punctuation">,</span> Invoice<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<ide-ative data-language="html" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>invoice-template<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>Room Rate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>room-rate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>199 USD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>#Rooms<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>room-count<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>#Nights<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>night-count<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>Total<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total-charge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1393 USD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">dl</span> <span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
      <span class="token property">width</span><span class="token punctuation">:</span> max-content<span class="token punctuation">;</span>
      <span class="token property">gap</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">dl &gt; div</span> <span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
      <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
      <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">dt</span> <span class="token punctuation">{</span>
      <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">dd</span> <span class="token punctuation">{</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  
</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h2>Implementing Observable with Proxy</h2>

<ide-ative data-language="js" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObservable</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> eventTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">OBSERVABLE_CHANGE_EVENT</span> <span class="token operator">=</span> <span class="token string">"observable:change"</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"creating Observable:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">===</span> <span class="token string">"then"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'] =&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> root<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'] &lt;= </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
          newValue
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; was </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> didSet <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>didSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token constant">OBSERVABLE_CHANGE_EVENT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">bubbles</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">cancelable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>evt<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">property</span><span class="token operator">:</span> prop<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> newValue <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventTarget<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dispatched event to target"</span><span class="token punctuation">,</span> evt<span class="token punctuation">,</span> eventTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] was not set to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> didSet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>
<oper-ative class="wyn4ozqi9"><!-- template --><output class="render">
  
</output>

<style>.wyn4ozqi9{height:100%;width:100%;overflow:auto;grid-column:var(--render-grid-column)}.wyn4ozqi9 .render{min-width:100%;min-height:100%;display:block;position:relative;padding:var(--sizeRenderPadding)}@media print{.wyn4ozqi9{display:block;height:auto;overflow:hidden}.wyn4ozqi9 .render{min-width:0;min-height:0}}</style>
<!-- /template -->
</oper-ative>
<ide-ative data-language="auto" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
<narr-ative class="wrjuayo-j"><!-- template id="narr-ative" webc:raw --><section class="prose">
  <h2>Appendix</h2>

<p>Helper function for creating templates from Javascript:</p>

<ide-ative data-language="js" class="wbxffgulu"><!-- template --><figure class="code">
  <figcaption></figcaption>
  <pre class="language-markup"><code class="language-js"><span class="token keyword">function</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> <span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">?</span> <span class="token punctuation">[</span>values<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tpl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html<span class="token punctuation">;</span>
  <span class="token keyword">return</span> tpl<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</figure>

<style>.wbxffgulu{--ide-language: attr(data-language);height:100%;width:100%;overflow:hidden;grid-column:var(--code-grid-column)}.wbxffgulu .code{height:max-content;max-width:100%;max-height:100%;overflow:auto}.wbxffgulu figcaption:empty::after{content:var(--ide-language, "code")}@media print{.wbxffgulu{display:block;height:auto;break-inside:avoid}}</style>
<!-- /template -->
</ide-ative>
</section>

<style>@import "/styles/theme.css";.wrjuayo-j{grid-column:var(--prose-grid-column);grid-row-end:span 2;overflow:hidden auto;height:100%;width:100%}.wrjuayo-j .prose{font-family:var(--fontBody);font-size:var(--textSizeProse);font-weight:var(--textWeightProse);line-height:var(--lineHeightProse);color:var(--textColorProse);outline:none;padding:10em 0 1em 0;height:min-content}.wrjuayo-j .prose>*{margin:1rem;position:relative}.wrjuayo-j .prose>ul,.wrjuayo-j .prose>ol{margin-left:2rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:65ch}.wrjuayo-j .prose>figure{margin:0.5rem}.wrjuayo-j .prose pre>*:focus{outline:none}.wrjuayo-j .prose>h1,.wrjuayo-j .prose>h2,.wrjuayo-j .prose>h3,.wrjuayo-j .prose>h4,.wrjuayo-j .prose>h5,.wrjuayo-j .prose>h6{font-family:var(--fontDisplay);font-weight:var(--textWeightHeading);color:var(--textColorHeading)}.wrjuayo-j .prose>h1{font-size:var(--textSizeH1)}.wrjuayo-j .prose>h2{font-size:var(--textSizeH2)}.wrjuayo-j .prose>h3{font-size:var(--textSizeH3)}.wrjuayo-j .prose pre[class*="language-"]{overflow:hidden}.wrjuayo-j .prose>*+*{margin-top:0.5em}.wrjuayo-j .prose>h1+*{margin-top:2em}.wrjuayo-j .prose ul,.wrjuayo-j .prose ol{padding-left:1em}.wrjuayo-j .prose ul>li,.wrjuayo-j .prose ol>li{position:relative}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>code{color:var(--textColorInlineCode);font-family:var(--fontCode);background:var(--backgroundInlineCode)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a{color:inherit;text-decoration:none;background:linear-gradient(transparent,transparent 50%,var(--backgroundLink));padding:0 0.25em;border:var(--borderLink);border-radius:var(--borderRadiusLink);cursor:pointer}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) a:hover{color:var(--textColorHoverLink)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) strong{font-weight:var(--textWeightStrong)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6) em{font-style:--var(textStyleEmphasis)}.wrjuayo-j .prose>br{margin:0;line-height:0}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)>*::after{display:inline;color:var(--textColorMarkup);background:var(--backgroundMarkup);font-family:var(--fontCode);line-height:var(--lineHeightMarkup);font-style:var(--textStyleMarkup);border-radius:var(--borderRadiusMarkup);font-size:var(--textSizeMarkup);font-weight:var(--textWeightMarkup);padding:var(--borderRadiusMarkup);vertical-align:0.2em;border:var(--borderMarkup);margin:0 0.1rem}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6)::before,.wrjuayo-j .prose>*>li::before{display:block;position:absolute;right:100%;top:0.2em;height:1rem;width:1rem}.wrjuayo-j .prose>ul::before,.wrjuayo-j .prose>ol::before{display:block;position:absolute;right:100%}.wrjuayo-j .prose>[data-mark-before]:focus::before{content:attr(data-mark-before)}.wrjuayo-j .prose>*:focus>li[data-mark-before]{list-style:none}.wrjuayo-j .prose>*:focus>li[data-mark-before]::before{content:attr(data-mark-before)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::before,.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus [data-mark-around]::after{content:attr(data-mark-around)}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::before{content:"["}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a::after{content:"]"}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6):focus a[href]::after{content:"]("attr(href)")"}@media print{.wrjuayo-j{break-before:page}.wrjuayo-j .prose{width:100%;display:flex;flex-direction:column;align-items:center}.wrjuayo-j .prose>:is(p,ul,ol,h1,h2,h3,h4,h5,h6){max-width:40rem;width:60%}}</style>
<!-- /template -->


</narr-ative>

</main>

<style>.wca28tbqe{--heightViewer: calc(100vh - var(--heightFooter));height:var(--heightViewer);overflow:hidden;position:relative}.wca28tbqe .layout{--render-grid-column: 1;--code-grid-column: 1;--prose-grid-column: 2;display:grid;position:relative;top:calc(var(--heightViewer)*(1 - var(--current-scene, 1)));grid-template-columns:60vw 40vw;grid-auto-rows:calc(0.6*var(--heightViewer)) calc(0.4*var(--heightViewer));grid-auto-flow:column;justify-items:start;transition:top 0.5s ease-in-out;pointer-events:none}.wca28tbqe .layout>*{pointer-events:all}@media print{.wca28tbqe .layout{--prose-grid-row: unset;--render-grid-row: unset;--code-grid-row: unset;position:relative;top:auto;left:auto;height:auto;grid-template-columns:initial;grid-template-rows:initial;grid-auto-columns:initial}.wca28tbqe .layout .render{break-before:page;break-inside:avoid;border:1px dotted black}.wca28tbqe .layout .code{overflow:visible}}</style>

<script>
  customElements.define(
    "consolid-ative",
    class extends HTMLElement {
      connectedCallback() {
        let provider = this.closest("[data-provider]");

        if (provider) {
          const { value: currentScene } = provider.observe(
            "current-scene",
            (newValue) => {
              console.log("Setting layout to scene", newValue);
              this.style = `--current-scene: ${newValue}`;
            }
          );

          console.log("Consolid-ative (webc)");
        }
      }
    }
  );
</script>
</consolid-ative>

</article>

<style>
  article {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column-reverse;
  }

  @media print {
    article {
      position: static;
      height: auto;
      width: 100%;
    }
  }
</style>
<!-- /template -->
</st-ative>
<script type="module">

import { mount } from "/scripts/oper.ative.js";
console.log("Mounting Operative");
const mountpoint = document.getElementById("lets-be-oper-ative");
const initial = {"count":10};
const moduleNames = ["Kram_d693e88c_state"];
moduleNames.forEach((name) => mount(name, mountpoint, initial));

</script>


</body>
</html>